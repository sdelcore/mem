worker_processes auto;
error_log /var/log/nginx/error.log warn;

events {
    worker_connections 1024;
}

# RTMP configuration
rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        allow publish all;
        allow play all;

        application live {
            live on;
            record off;

            # Allow up to 10 concurrent streams
            max_connections 10;

            # When stream starts, notify backend to validate stream key
            # Returns 2xx to allow, anything else rejects
            on_publish http://mem-backend:8000/api/streams/rtmp-callback/publish;
            on_publish_done http://mem-backend:8000/api/streams/rtmp-callback/publish-done;

            # Stream playback callbacks (allow all for now)
            on_play http://mem-backend:8000/api/streams/rtmp-callback/play;
            on_play_done http://mem-backend:8000/api/streams/rtmp-callback/play-done;

            # Extract frames and send to backend for processing
            # The stream_handler.py script extracts JPEG frames using FFmpeg
            # and POSTs them to the backend's frame ingestion endpoint
            exec_push /usr/local/bin/stream_handler.py extract_frames $name;

            # HLS output for web playback (optional)
            hls on;
            hls_path /data/streams/hls;
            hls_fragment 3;
            hls_playlist_length 60;
            hls_cleanup on;

            # DASH output (optional)
            dash on;
            dash_path /data/streams/dash;
            dash_fragment 3;
            dash_playlist_length 60;
            dash_cleanup on;
        }

        # Separate application for testing
        application test {
            live on;
            record off;
        }
    }
}

# HTTP configuration for stats and HLS/DASH delivery
http {
    sendfile on;
    tcp_nopush on;
    directio 512;
    default_type application/octet-stream;

    server {
        listen 8080;
        server_name _;

        # RTMP statistics
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }

        location /stat.xsl {
            root /usr/local/nginx/html;
        }

        # HLS delivery
        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /data/streams;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
        }

        # DASH delivery
        location /dash {
            root /data/streams;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
        }

        # Health check
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Control API
        location /control {
            rtmp_control all;
            add_header Access-Control-Allow-Origin *;
        }
    }
}
