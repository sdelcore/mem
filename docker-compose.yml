# Mem Docker Compose Configuration

services:
  sttd:
    image: registry.sdelcore.com/mem/sttd:${TAG:-latest}
    container_name: mem-sttd
    restart: unless-stopped
    ports:
      - "${STTD_PORT:-8765}:8765"
    networks:
      - mem-network
    volumes:
      - sttd-models:/root/.cache/huggingface
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '4'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8765/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  mem-backend:
    image: registry.sdelcore.com/mem/backend:${TAG:-latest}
    build:
      context: ./mem
      dockerfile: Dockerfile
    container_name: mem-backend
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
      - MEM_CONFIG_PATH=/app/config/config.yaml
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - RTMP_HOST=${RTMP_HOST:-localhost}
    volumes:
      - ./data/db:/data/db
      - ./data/uploads:/data/uploads
      - ./data/config:/app/config:ro
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    networks:
      - mem-network
    depends_on:
      sttd:
        condition: service_healthy
        required: false
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  mem-frontend:
    image: registry.sdelcore.com/mem/frontend:${TAG:-latest}
    build:
      context: ./mem-ui
      dockerfile: Dockerfile
    container_name: mem-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-80}:80"
    networks:
      - mem-network
    depends_on:
      mem-backend:
        condition: service_started
        required: false
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3

  mem-rtmp:
    image: registry.sdelcore.com/mem/rtmp:${TAG:-latest}
    build:
      context: ./rtmp
      dockerfile: Dockerfile
    container_name: mem-rtmp
    restart: unless-stopped
    ports:
      - "${RTMP_PORT:-1935}:1935"
      - "${RTMP_STATS_PORT:-8080}:8080"
    networks:
      - mem-network
    depends_on:
      mem-backend:
        condition: service_started
        required: false
    volumes:
      - ./data/streams:/data/streams
    environment:
      - BACKEND_URL=http://mem-backend:8000
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '2'
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "1935"]
      interval: 30s
      timeout: 3s
      retries: 3

networks:
  mem-network:
    driver: bridge

volumes:
  sttd-models:
    driver: local
